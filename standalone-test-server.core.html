<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>standalone-test-server.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Standalone-test-server</span> <span class="project-version">0.6.2-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Standalone Test Server</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>standalone-test-server</span></div></div></li><li class="depth-2 branch current"><a href="standalone-test-server.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><a href="standalone-test-server.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="standalone-test-server.core.html#var-recording-endpoint"><div class="inner"><span>recording-endpoint</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-recording-requests"><div class="inner"><span>recording-requests</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-recording-responses"><div class="inner"><span>recording-responses</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-recording-traffic"><div class="inner"><span>recording-traffic</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-count.3F"><div class="inner"><span>requests-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-meet.3F"><div class="inner"><span>requests-meet?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-min-count.3F"><div class="inner"><span>requests-min-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-quiescent"><div class="inner"><span>requests-quiescent</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-responses-count.3F"><div class="inner"><span>responses-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-responses-meet.3F"><div class="inner"><span>responses-meet?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-responses-min-count.3F"><div class="inner"><span>responses-min-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-responses-quiescent"><div class="inner"><span>responses-quiescent</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-standalone-server"><div class="inner"><span>standalone-server</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-traffic-count.3F"><div class="inner"><span>traffic-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-traffic-meets.3F"><div class="inner"><span>traffic-meets?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-traffic-min-count.3F"><div class="inner"><span>traffic-min-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-traffic-quiescent"><div class="inner"><span>traffic-quiescent</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-with-standalone-server"><div class="inner"><span>with-standalone-server</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">standalone-test-server.core</h1><div class="doc"><div class="markdown"><p>Provides a ring handler that can record received requests.</p></div></div><div class="public anchor" id="var-recording-endpoint"><h3>recording-endpoint</h3><h4 class="deprecated">deprecated in 0.6.1</h4><div class="usage"></div><div class="doc"><div class="markdown"><p>Deprecated synonym for <a href="standalone-test-server.core.html#var-recording-requests">recording-requests</a></p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L168">view source</a></div></div><div class="public anchor" id="var-recording-requests"><h3>recording-requests</h3><div class="usage"><code>(recording-requests &amp; args)</code></div><div class="doc"><div class="markdown"><p>Like <a href="standalone-test-server.core.html#var-recording-traffic">recording-traffic</a> but the first item in the returned tuple is only the <code>requests</code>.</p>
<p>If you need to ensure a condition of the <code>requests</code> atom is satisfied before deref-ing it, use <a href="standalone-test-server.core.html#var-requests-meet.3F">requests-meet?</a>, <a href="standalone-test-server.core.html#var-requests-count.3F">requests-count?</a> or a related helper.</p>
<p>Example invocations:</p>
<pre><code class="clj">;; Waits up to 1000ms for a single request
(let [[requests handler] (recording-requests)]
  (is (requests-meet? requests first {:timeout 1000}))
  (first @requests))

;; Waits up to 1000ms for two requests
(let [[requests handler] (recording-requests)]
  (is (requests-meet? requests second {:timeout 1000}))
  (take 2 @requests))
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L144">view source</a></div></div><div class="public anchor" id="var-recording-responses"><h3>recording-responses</h3><div class="usage"><code>(recording-responses &amp; args)</code></div><div class="doc"><div class="markdown"><p>Like <a href="standalone-test-server.core.html#var-recording-traffic">recording-traffic</a> but the first item in the returned tuple is only the <code>responses</code>.</p>
<p>If you need to ensure a condition of the <code>responses</code> atom is satisfied before deref-ing it, use <a href="standalone-test-server.core.html#var-responses-meet.3F">responses-meet?</a>, <a href="standalone-test-server.core.html#var-responses-count.3F">responses-count?</a> or a related helper.</p>
<p>Example invocations:</p>
<pre><code class="clj">;; Waits up to 1000ms for a single response
(let [[responses handler] (recording-responses)]
  (is (responses-meet? responses first {:timeout 1000}))
  (first @responses))

;; Waits up to 1000ms for two responses
(let [[responses handler] (recording-responses)]
  (is (responses-meet? responses second {:timeout 1000}))
  (take 2 @responses))
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L172">view source</a></div></div><div class="public anchor" id="var-recording-traffic"><h3>recording-traffic</h3><div class="usage"><code>(recording-traffic &amp; [{:keys [handler], :or {handler default-handler}}])</code></div><div class="doc"><div class="markdown"><p>Creates a ring handler that can record the traffic that flows through it.</p>
<p>Options:</p>
<ul>
  <li><strong><code>handler</code></strong> The handler for <code>recording-traffic</code> to wrap. Defaults to a  handler that returns status 200 with an empty body.</li>
</ul>
<p>Returns:</p>
<pre><code class="clj">[{:requests  requests-atom
  :responses responses-atom}
 recording-handler]
</code></pre>
<p>The <code>requests-atom</code> contains a vector of requests received by the <code>recording-handler.</code> Each item in the <code>responses-atom</code> will be a map of the <code>request</code> and its corresponding <code>response</code>. If the handler is slow, items will show up in the <code>requests-atom</code> before showing up in the <code>responses-atom.</code></p>
<p>The requests are standard ring requests except that the <code>:body</code> will be a string instead of <code>InputStream.</code></p>
<p>Example invocations:</p>
<pre><code class="clj">;; Returns a 404 response to the http client that hits this handler
(recording-traffic {:handler (constantly {:status 404 :headers {}})})
</code></pre>
<p>See <a href="standalone-test-server.core.html#var-with-standalone-server">with-standalone-server</a> for an example of how to use <code>recording-traffic</code> with a <a href="standalone-test-server.core.html#var-standalone-server">standalone-server</a>.</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L94">view source</a></div></div><div class="public anchor" id="var-requests-count.3F"><h3>requests-count?</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-count.3F">traffic-count?</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L86">view source</a></div></div><div class="public anchor" id="var-requests-meet.3F"><h3>requests-meet?</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-meets.3F">traffic-meets?</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L85">view source</a></div></div><div class="public anchor" id="var-requests-min-count.3F"><h3>requests-min-count?</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-min-count.3F">traffic-min-count?</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L87">view source</a></div></div><div class="public anchor" id="var-requests-quiescent"><h3>requests-quiescent</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-quiescent">traffic-quiescent</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L88">view source</a></div></div><div class="public anchor" id="var-responses-count.3F"><h3>responses-count?</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-count.3F">traffic-count?</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L90">view source</a></div></div><div class="public anchor" id="var-responses-meet.3F"><h3>responses-meet?</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-meets.3F">traffic-meets?</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L89">view source</a></div></div><div class="public anchor" id="var-responses-min-count.3F"><h3>responses-min-count?</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-min-count.3F">traffic-min-count?</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L91">view source</a></div></div><div class="public anchor" id="var-responses-quiescent"><h3>responses-quiescent</h3><div class="usage"></div><div class="doc"><div class="markdown"><p>Synonym for <a href="standalone-test-server.core.html#var-traffic-quiescent">traffic-quiescent</a>, but makes tests more legible</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L92">view source</a></div></div><div class="public anchor" id="var-standalone-server"><h3>standalone-server</h3><div class="usage"><code>(standalone-server handler &amp; [opts])</code></div><div class="doc"><div class="markdown"><p>Wrapper to start a standalone server through <code>ring-jetty.</code> Takes a ring handler and if desired, options to pass through to <code>run-jetty</code>.</p>
<p>The options default to <code>:port 4334</code> and <code>:join? false</code>.</p>
<p>Example:</p>
<pre><code class="clj">(standalone-server handler {:port 4335})
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L195">view source</a></div></div><div class="public anchor" id="var-traffic-count.3F"><h3>traffic-count?</h3><div class="usage"><code>(traffic-count? traffic exact-count)</code><code>(traffic-count? traffic exact-count options)</code></div><div class="doc"><div class="markdown"><p>Convenience for calling</p>
<pre><code class="clj">(traffic-meets? traffic-atom #(= exact-count (count %)) options)
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L47">view source</a></div></div><div class="public anchor" id="var-traffic-meets.3F"><h3>traffic-meets?</h3><div class="usage"><code>(traffic-meets? traffic pred)</code><code>(traffic-meets? traffic pred {:keys [timeout], :or {timeout default-timeout}})</code></div><div class="doc"><div class="markdown"><p>Blocks until the given <code>traffic</code> atom satisfies a predicate or the timeout has been reached.</p>
<p>Returns true or false respectively.</p>
<p>The predicate function takes the state of the <code>traffic</code> as the only argument. It is tested after every change to the <code>traffic.</code></p>
<p>There is one optional argument:</p>
<ul>
  <li><code>:timeout</code> the period of time (in milliseconds) to wait until returning false; defaults to 500.</li>
</ul>
<p>Also note that the predicate function may be called on multiple threads simultaneously.</p>
<pre><code class="clj">;; Reports whether traffic-atom has at least 2 items before 3 seconds have elapsed.
(traffic-meets? traffic-atom #(&lt;= 2 (count %)) {:timeout 3000})
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L15">view source</a></div></div><div class="public anchor" id="var-traffic-min-count.3F"><h3>traffic-min-count?</h3><div class="usage"><code>(traffic-min-count? traffic min-count)</code><code>(traffic-min-count? traffic min-count options)</code></div><div class="doc"><div class="markdown"><p>Convenience for calling</p>
<pre><code class="clj">(traffic-meets? traffic-atom #(&lt;= min-count (count %)) options)
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L58">view source</a></div></div><div class="public anchor" id="var-traffic-quiescent"><h3>traffic-quiescent</h3><div class="usage"><code>(traffic-quiescent traffic)</code><code>(traffic-quiescent traffic {:keys [for-ms], :or {for-ms default-timeout}})</code></div><div class="doc"><div class="markdown"><p>Blocks until the given traffic traffic has stopped growing for <code>for-ms</code></p>
<p>Returns nil.</p>
<p>There is one optional argument:</p>
<ul>
  <li><code>:for-ms</code> How long to wait after receiving the last request before declaring  quiescence; defaults to 500.</li>
</ul></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L69">view source</a></div></div><div class="public anchor" id="var-with-standalone-server"><h3>with-standalone-server</h3><h4 class="type">macro</h4><div class="usage"><code>(with-standalone-server bindings &amp; body)</code></div><div class="doc"><div class="markdown"><p>A convenience macro to ensure a <a href="standalone-test-server.core.html#var-standalone-server">standalone-server</a> is stopped.</p>
<p>Example with <a href="standalone-test-server.core.html#var-standalone-server">standalone-server</a> and <a href="null">recording-requests:</a></p>
<pre><code class="clj">(let [[requests handler] (recording-requests)]
  (with-standalone-server [server (standalone-server handler)]
    (http/get "http://localhost:4334/endpoint")
    (is (requests-count? requests 1))))
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L208">view source</a></div></div></div></body></html>