<!DOCTYPE html PUBLIC ""
    "">
<html><head><meta charset="UTF-8" /><title>standalone-test-server.core documentation</title><link rel="stylesheet" type="text/css" href="css/default.css" /><link rel="stylesheet" type="text/css" href="css/highlight.css" /><script type="text/javascript" src="js/highlight.min.js"></script><script type="text/javascript" src="js/jquery.min.js"></script><script type="text/javascript" src="js/page_effects.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body><div id="header"><h2>Generated by <a href="https://github.com/weavejester/codox">Codox</a></h2><h1><a href="index.html"><span class="project-title"><span class="project-name">Standalone-test-server</span> <span class="project-version">0.7.3-SNAPSHOT</span></span></a></h1></div><div class="sidebar primary"><h3 class="no-link"><span class="inner">Project</span></h3><ul class="index-link"><li class="depth-1 "><a href="index.html"><div class="inner">Index</div></a></li></ul><h3 class="no-link"><span class="inner">Topics</span></h3><ul><li class="depth-1 "><a href="README.html"><div class="inner"><span>Standalone Test Server</span></div></a></li></ul><h3 class="no-link"><span class="inner">Namespaces</span></h3><ul><li class="depth-1"><div class="no-link"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>standalone-test-server</span></div></div></li><li class="depth-2 branch current"><a href="standalone-test-server.core.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>core</span></div></a></li><li class="depth-2"><a href="standalone-test-server.query.html"><div class="inner"><span class="tree"><span class="top"></span><span class="bottom"></span></span><span>query</span></div></a></li></ul></div><div class="sidebar secondary"><h3><a href="#top"><span class="inner">Public Vars</span></a></h3><ul><li class="depth-1"><a href="standalone-test-server.core.html#var-recording-endpoint"><div class="inner"><span>recording-endpoint</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-count.3F"><div class="inner"><span>requests-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-meet.3F"><div class="inner"><span>requests-meet?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-min-count.3F"><div class="inner"><span>requests-min-count?</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-requests-quiescent"><div class="inner"><span>requests-quiescent</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-seq-handler"><div class="inner"><span>seq-handler</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-standalone-server"><div class="inner"><span>standalone-server</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-txfm-request"><div class="inner"><span>txfm-request</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-txfm-requests"><div class="inner"><span>txfm-requests</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-with-requests-chan"><div class="inner"><span>with-requests-chan</span></div></a></li><li class="depth-1"><a href="standalone-test-server.core.html#var-with-standalone-server"><div class="inner"><span>with-standalone-server</span></div></a></li></ul></div><div class="namespace-docs" id="content"><h1 class="anchor" id="top">standalone-test-server.core</h1><div class="doc"><div class="markdown"><p>Provides a ring handler that can record received requests.</p></div></div><div class="public anchor" id="var-recording-endpoint"><h3>recording-endpoint</h3><h4 class="deprecated">deprecated in 0.7.2</h4><div class="usage"><code>(recording-endpoint &amp; [{:keys [handler], :or {handler default-handler}}])</code></div><div class="doc"><div class="markdown"><p>DEPRECATED: Use <a href="standalone-test-server.core.html#var-with-requests-chan">with-requests-chan</a> instead.</p>
<p>Creates a ring handler that can record the requests that flows through it.</p>
<p>Options:</p>
<ul>
  <li><strong><code>handler</code></strong> The handler for <code>recording-endpoint</code> to wrap. Defaults to a  handler that returns status 200 with an empty body.</li>
</ul>
<p>Returns:</p>
<pre><code class="clj">[requests-atom recording-handler]
</code></pre>
<p>The <code>requests-atom</code> contains a vector of requests received by the <code>recording-handler.</code></p>
<p>The requests are standard ring requests except that the <code>:body</code> will be a string instead of <code>InputStream.</code></p>
<p>Example invocations:</p>
<pre><code class="clj">;; Returns a 404 response to the http client that hits this handler
(recording-endpoint {:handler (constantly {:status 404 :headers {}})})
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L98">view source</a></div></div><div class="public anchor" id="var-requests-count.3F"><h3>requests-count?</h3><h4 class="deprecated">deprecated in 0.7.2</h4><div class="usage"><code>(requests-count? requests exact-count)</code><code>(requests-count? requests exact-count options)</code></div><div class="doc"><div class="markdown"><p>DEPRECATED: Use <a href="standalone-test-server.core.html#var-txfm-requests">txfm-requests</a> instead</p>
<p>Convenience for calling</p>
<pre><code class="clj">(requests-meet? requests-atom #(= exact-count (count %)) options)
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L51">view source</a></div></div><div class="public anchor" id="var-requests-meet.3F"><h3>requests-meet?</h3><h4 class="deprecated">deprecated in 0.7.2</h4><div class="usage"><code>(requests-meet? requests pred)</code><code>(requests-meet? requests pred {:keys [timeout], :or {timeout default-timeout}})</code></div><div class="doc"><div class="markdown"><p>DEPRECATED: Use <a href="standalone-test-server.core.html#var-txfm-requests">txfm-requests</a> instead</p>
<p>Blocks until the given <code>requests</code> atom satisfies a predicate or the timeout has been reached.</p>
<p>Returns true or false respectively.</p>
<p>The predicate function takes the state of the <code>requests</code> as the only argument. It is tested after every change to the <code>requests.</code></p>
<p>There is one optional argument:</p>
<ul>
  <li><code>:timeout</code> the period of time (in milliseconds) to wait until returning false; defaults to 500.</li>
</ul>
<p>Also note that the predicate function may be called on multiple threads simultaneously.</p>
<pre><code class="clj">;; Reports whether requests-atom has at least 2 items before 3 seconds have elapsed.
(requests-meet? requests-atom #(&lt;= 2 (count %)) {:timeout 3000})
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L16">view source</a></div></div><div class="public anchor" id="var-requests-min-count.3F"><h3>requests-min-count?</h3><h4 class="deprecated">deprecated in 0.7.2</h4><div class="usage"><code>(requests-min-count? requests min-count)</code><code>(requests-min-count? requests min-count options)</code></div><div class="doc"><div class="markdown"><p>DEPRECATED: Use <a href="standalone-test-server.core.html#var-txfm-requests">txfm-requests</a> instead</p>
<p>Convenience for calling</p>
<pre><code class="clj">(requests-meet? requests-atom #(&lt;= min-count (count %)) options)
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L65">view source</a></div></div><div class="public anchor" id="var-requests-quiescent"><h3>requests-quiescent</h3><h4 class="deprecated">deprecated in 0.7.2</h4><div class="usage"><code>(requests-quiescent requests)</code><code>(requests-quiescent requests {:keys [for-ms], :or {for-ms default-timeout}})</code></div><div class="doc"><div class="markdown"><p>DEPRECATED: Use <a href="standalone-test-server.core.html#var-txfm-requests">txfm-requests</a> instead</p>
<p>Blocks until the given requests requests has stopped growing for <code>for-ms</code></p>
<p>Returns nil.</p>
<p>There is one optional argument:</p>
<ul>
  <li><code>:for-ms</code> How long to wait after receiving the last request before declaring  quiescence; defaults to 500.</li>
</ul></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L79">view source</a></div></div><div class="public anchor" id="var-seq-handler"><h3>seq-handler</h3><div class="usage"><code>(seq-handler &amp; handlers)</code></div><div class="doc"><div class="markdown"><p>A helper function which iterates through a sequence of handlers using a new one for each call to the handler.</p>
<p>Uses the default handler when out of handlers to use.</p>
<p>Example</p>
<pre><code class="clj">(with-requests-chan (seq-handler
                      ;;first handler
                      (fn [req] {:status 200 :body "ok"})
                      ;;second handler
                      (fn [req] {:status 400 :body "bad"})))
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L259">view source</a></div></div><div class="public anchor" id="var-standalone-server"><h3>standalone-server</h3><div class="usage"><code>(standalone-server handler &amp; [opts])</code></div><div class="doc"><div class="markdown"><p>Wrapper to start a standalone server through <code>ring-jetty.</code> Takes a ring handler and if desired, options to pass through to <code>run-jetty</code>.</p>
<p>The options default to <code>:port 4334</code> and <code>:join? false</code>.</p>
<p>Example:</p>
<pre><code class="clj">(standalone-server handler {:port 4335})
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L222">view source</a></div></div><div class="public anchor" id="var-txfm-request"><h3>txfm-request</h3><div class="usage"><code>(txfm-request requests)</code><code>(txfm-request requests xf)</code><code>(txfm-request requests xf opts)</code></div><div class="doc"><div class="markdown"><p>Convenience for extracting the first request in a channel of <code>requests</code> which satisifies the transform <code>tx</code>. With no transform, or a transform that doesn’t filter results, just returns the first request.</p></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L171">view source</a></div></div><div class="public anchor" id="var-txfm-requests"><h3>txfm-requests</h3><div class="usage"><code>(txfm-requests requests xf)</code><code>(txfm-requests requests xf {:keys [timeout]})</code></div><div class="doc"><div class="markdown"><p>Accepts a channel of <code>requests</code> and a transducing function <code>xf</code> which can <code>filter</code>, <code>take</code>, or <code>drop</code> requests. Especially useful to centralize the transformation of requests bodies, using <code>(map #(update :body % ...))</code>.</p>
<p>Blocks until the <code>xf</code> is reduced or the timeout has been reached. As such, to avoid unnecessary pauses, <code>take</code> as many requests as you expect to receive.</p>
<p>There is one optional argument:</p>
<ul>
  <li><strong><code>:timeout</code></strong> the period of time (in milliseconds) to wait until returning what  has been fetched so far; defaults to 500.</li>
</ul>
<pre><code class="clj">;; Returns upto 2 requests, as many as are produced within 3 seconds.
(txfm-requests requests-chan (take 2) {:timeout 3000})
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L139">view source</a></div></div><div class="public anchor" id="var-with-requests-chan"><h3>with-requests-chan</h3><div class="usage"><code>(with-requests-chan)</code><code>(with-requests-chan handler)</code><code>(with-requests-chan handler buf-or-n)</code></div><div class="doc"><div class="markdown"><p>Creates a ring handler that can record the requests that flow through it.</p>
<p>Options:</p>
<ul>
  <li><strong><code>handler</code></strong> The handler for `with-requests-chan`` to wrap. Defaults to a  handler that returns status 200 with an empty body.</li>
  <li><strong><code>buf-or-n</code></strong> The buffer configuration for the channel, defaults to 100.</li>
</ul>
<p>Returns:</p>
<pre><code class="clj">[requests-chan wrapped-handler]
</code></pre>
<p>The <code>requests-chan</code> holds the requests received by the handler. <a href="standalone-test-server.core.html#var-txfm-requests">txfm-requests</a> can extract the requests from it.</p>
<p>The requests are standard ring requests except that the <code>:body</code> will be a string instead of <code>InputStream.</code></p>
<p>Example invocations:</p>
<pre><code class="clj">;; Returns a 404 response to the http client that hits this handler
(with-requests-chan (constantly {:status 404 :headers {}}))
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L181">view source</a></div></div><div class="public anchor" id="var-with-standalone-server"><h3>with-standalone-server</h3><h4 class="type">macro</h4><div class="usage"><code>(with-standalone-server bindings &amp; body)</code></div><div class="doc"><div class="markdown"><p>A convenience macro to ensure a <a href="standalone-test-server.core.html#var-standalone-server">standalone-server</a> is stopped.</p>
<p>Example with <a href="standalone-test-server.core.html#var-standalone-server">standalone-server</a> and <a href="standalone-test-server.core.html#var-with-requests-chan">with-requests-chan</a></p>
<pre><code class="clj">(let [[requests handler] (with-requests-chan)]
  (with-standalone-server [server (standalone-server handler)]
    (http/get "http://localhost:4334/endpoint")
    (is (txfm-request requests))))
</code></pre></div></div><div class="src-link"><a href="http://github.com/Mayvenn/standalone-test-server/blob/master/src/standalone_test_server/core.clj#L235">view source</a></div></div></div></body></html>